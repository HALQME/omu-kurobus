---
export const prerender = false;
import Layout from "@/src/layouts/layout.astro";
import { styles } from "@/styles/style";
import CourseInfo from "@/src/components/course-info.astro";
import {
    CourseReviewSubmissionSchema,
    courseTypes,
    evalCriteriaTypes,
    testItemTypes,
} from "@/types/schema";
import type { CourseReviewSubmission, testTypes } from "@/types/schema";

import { post } from "@/utils/post";
import { hasSubmitPair } from "@/utils/const";

const { year, semester, id } = Astro.params;
if (!id || !year || !semester) {
    return Astro.redirect("/404");
}

if (!hasSubmitPair()) {
    return Astro.redirect("/404"); // submit type pair がない場合は投稿をブロック
}

let errors = {
    courseTypes: "",
    evalCriteria: "",
    classDifficulty: "",
    testDifficulty: "",
    testAmount: "",
    gradingCriteria: "",
    totalscore: "",
};

let formData: CourseReviewSubmission | null = null;

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();

        const student_department = data.get("studentNumber");
        const courseType = data.getAll("courseType");
        const courseTypeOtherText = data.get("courseTypeOtherText");
        const evalCriteria = data.getAll("evalCriteria");
        const evalCriteriaOtherText = data.get("evalCriteriaOtherText");
        const testType = data.get("testType");
        const testTypeOtherText = data.get("testTypeOtherText");
        const testItems = data.getAll("testItems");
        const testItemsOtherText = data.get("testItemsOtherText");
        const classDifficulty = data.get("classDifficulty")
            ? Number(data.get("classDifficulty"))
            : undefined;
        const testDifficulty = data.get("testDifficulty")
            ? Number(data.get("testDifficulty"))
            : undefined;
        const testAmount = data.get("testAmount")
            ? Number(data.get("testAmount"))
            : undefined;
        const gradingCriteria = data.get("gradingCriteria")
            ? Number(data.get("gradingCriteria"))
            : undefined;
        const totalscore = data.get("totalscore")
            ? Number(data.get("totalscore"))
            : undefined;
        const goodPoint = data.get("goodPoint");
        const notGoodPoint = data.get("notGoodPoint");
        const comment = data.get("comment");

        if (courseType.length === 0) {
            errors.courseTypes = "この項目は必須です。";
        }
        if (evalCriteria.length === 0) {
            errors.evalCriteria = "この項目は必須です。";
        }
        if (!classDifficulty) {
            errors.classDifficulty = "この項目は必須です。";
        } else if (classDifficulty == 0) {
            errors.classDifficulty = "初期値は許可されていません。";
        }
        if (!testDifficulty) {
            errors.testDifficulty = "この項目は必須です";
        }
        if (!testAmount && testAmount === 0) {
            errors.testAmount = "この項目は必須です";
        }
        if (!gradingCriteria && gradingCriteria === 0) {
            errors.gradingCriteria = "この項目は必須です";
        }
        if (!totalscore && totalscore === 0) {
            errors.totalscore = "この項目は必須です";
        }
        const hasErrors = Object.values(errors).some((error) => error !== "");
        formData = {
            course_id: id as string,
            student_department: (student_department as string).slice(0, 3),
            courseType: courseType as (typeof courseTypes)[number][],
            courseTypeOtherText: courseTypeOtherText as string,
            evalCriteria: evalCriteria as (typeof evalCriteriaTypes)[number][],
            evalCriteriaOtherText: evalCriteriaOtherText as string,
            testType: testType as (typeof testTypes)[number],
            testTypeOtherText: testTypeOtherText as string,
            testItems: testItems as (typeof testItemTypes)[number][],
            testItemsOtherText: testItemsOtherText as string,
            classDifficulty: classDifficulty!,
            testDifficulty: testDifficulty!,
            testAmount: testAmount!,
            gradingCriteria: gradingCriteria!,
            totalScore: totalscore!,
            goodPoint: goodPoint as string,
            notGoodPoint: notGoodPoint as string,
            comment: comment as string,
        };
        if (!hasErrors) {
            const result = CourseReviewSubmissionSchema.safeParse(formData);
            if (result.success) {
                const response = await post(result.data);
                if (response.rowsAffected === 1) {
                    console.log(
                        "Sucsess to write Data",
                        response.lastInsertRowid
                    );
                    return Astro.redirect(
                        `/submit/${year}/${semester}/success?id=${id}`
                    );
                } else {
                    console.error(
                        "Failed to post data: miss match rowsAffected"
                    );
                    return Astro.redirect(`/failed/?id=${id}`);
                }
            } else {
                console.error("Failed to post data: invalid data");
                return Astro.redirect(`failed/?id=${id}`);
            }
        }
    } catch (error) {
        console.error("Failed to post data: ", error);
        return Astro.redirect(`failed/?id=${id}`);
    }
}
---

<Layout title="感想投稿" description="授業の感想を共有しよう">
    <section class={styles.section.container}>
        <div class={styles.section.headingWrapper}>
            <div
                class={`${styles.section.headingLine} ${styles.section.headingLineLeft}`}
            >
            </div>
            <h2 class={styles.section.title}>感想を投稿</h2>
            <div
                class={`${styles.section.headingLine} ${styles.section.headingLineRight}`}
            >
            </div>
        </div>
        <div class={styles.section.content}>
            <CourseInfo id={id} />
            <form method="POST">
                <input type="hidden" name="course_id" value={id} />
                <div class="mb-4">
                    <label for="studentNumber" class={styles.form.label}>
                        学籍番号<span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        id="studentNumber"
                        name="studentNumber"
                        class={`${styles.form.input}`}
                        pattern="[A-Z]{3}[0-9]{5}"
                        required
                        value={""}
                    />
                    <small>
                        この情報はデータベースに登録されません。学部・学科の情報の確認に使用されます。
                    </small>
                </div>
                <div class="mb-4">
                    <section class="mb-4" aria-labelledby="evaluation-style">
                        <h3
                            id="evaluation-style"
                            class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200"
                        >
                            評価方法
                        </h3>

                        <!-- 講義・実習の実施形態 -->
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                授業形態<span class="text-red-500">*</span>
                            </label>
                            <div class={styles.checkboxGroup.container}>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="courseType1"
                                        name="courseType"
                                        value="対面または実習"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="courseType1"
                                        class={styles.checkboxGroup.label}
                                        >対面・実習</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="courseType2"
                                        name="courseType"
                                        value="同期オンライン"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="courseType2"
                                        class={styles.checkboxGroup.label}
                                        >同期オンライン</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="courseType3"
                                        name="courseType"
                                        value="非同期オンライン"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="courseType3"
                                        class={styles.checkboxGroup.label}
                                        >非同期オンライン</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.other}>
                                    <input
                                        type="checkbox"
                                        id="courseTypeOther"
                                        name="courseType"
                                        value="その他"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="courseTypeOther"
                                        class={styles.checkboxGroup.label}
                                        >その他:</label
                                    >
                                    <input
                                        type="text"
                                        id="courseTypeOtherText"
                                        name="courseTypeOtherText"
                                        class={styles.checkboxGroup.otherInput}
                                        autocapitalize="off"
                                        placeholder="具体的に記入"
                                    />
                                </div>
                            </div>
                            {
                                errors.courseTypes && (
                                    <p class="text-red-500 text-sm">
                                        {errors.courseTypes}
                                    </p>
                                )
                            }
                        </div>
                        <!-- 評価基準 -->
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                評価基準<span class="text-red-500">*</span>
                            </label>
                            <div class={styles.checkboxGroup.container}>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria1"
                                        name="evalCriteria"
                                        value="出席点"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria1"
                                        class={styles.checkboxGroup.label}
                                        >出席点</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria2"
                                        name="evalCriteria"
                                        value="期末テスト"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria2"
                                        class={styles.checkboxGroup.label}
                                        >期末テスト</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria3"
                                        name="evalCriteria"
                                        value="中間テスト"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria3"
                                        class={styles.checkboxGroup.label}
                                        >中間テスト</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria4"
                                        name="evalCriteria"
                                        value="期末レポート"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria4"
                                        class={styles.checkboxGroup.label}
                                        >期末レポート</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria5"
                                        name="evalCriteria"
                                        value="中間レポート"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria5"
                                        class={styles.checkboxGroup.label}
                                        >中間レポート</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteria6"
                                        name="evalCriteria"
                                        value="毎回の課題"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteria6"
                                        class={styles.checkboxGroup.label}
                                        >毎回の課題</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.other}>
                                    <input
                                        type="checkbox"
                                        id="evalCriteriaOther"
                                        name="evalCriteria"
                                        value="その他"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="evalCriteriaOther"
                                        class={styles.checkboxGroup.label}
                                        >その他:</label
                                    >
                                    <input
                                        type="text"
                                        id="evalCriteriaOtherText"
                                        name="evalCriteriaOtherText"
                                        class={styles.checkboxGroup.otherInput}
                                        autocapitalize="off"
                                        placeholder="具体的に記入"
                                    />
                                </div>
                            </div>
                            {
                                errors.evalCriteria && (
                                    <p class="text-red-500 text-sm">
                                        {errors.evalCriteria}
                                    </p>
                                )
                            }
                        </div>

                        {/* テストの実施形態 */}
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                テストの実施形態
                            </label>
                            <div class={styles.checkboxGroup.container}>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="radio"
                                        id="testType1"
                                        name="testType"
                                        value="対面・筆記"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testType1"
                                        class={styles.checkboxGroup.label}
                                        >対面・筆記</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="radio"
                                        id="testType2"
                                        name="testType"
                                        value="対面・ウェブ"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testType2"
                                        class={styles.checkboxGroup.label}
                                        >対面・ウェブ</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="radio"
                                        id="testType3"
                                        name="testType"
                                        value="遠隔"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testType2"
                                        class={styles.checkboxGroup.label}
                                        >遠隔</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.other}>
                                    <input
                                        type="radio"
                                        id="testTypeOther"
                                        name="testType"
                                        value="その他"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testTypeOther"
                                        class={styles.checkboxGroup.label}
                                        >その他:</label
                                    >
                                    <input
                                        type="text"
                                        id="testTypeOtherText"
                                        name="testTypeOtherText"
                                        class={styles.checkboxGroup.otherInput}
                                        autocapitalize="off"
                                        placeholder="具体的に記入"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- テスト持ち込み -->
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                テスト持ち込み
                            </label>
                            <div class={styles.checkboxGroup.container}>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="testItems1"
                                        name="testItems"
                                        value="持ち込み無し"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testItems1"
                                        class={styles.checkboxGroup.label}
                                        >持ち込み無し</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="testItems2"
                                        name="testItems"
                                        value="レジュメ"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testItems2"
                                        class={styles.checkboxGroup.label}
                                        >レジュメ</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="testItems3"
                                        name="testItems"
                                        value="自筆ノート"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testItems3"
                                        class={styles.checkboxGroup.label}
                                        >自筆ノート</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.item}>
                                    <input
                                        type="checkbox"
                                        id="testItems4"
                                        name="testItems"
                                        value="教科書"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testItems4"
                                        class={styles.checkboxGroup.label}
                                        >教科書</label
                                    >
                                </div>
                                <div class={styles.checkboxGroup.other}>
                                    <input
                                        type="checkbox"
                                        id="testItemsOther"
                                        name="testItems"
                                        value="その他"
                                        class={styles.checkboxGroup.input}
                                    />
                                    <label
                                        for="testItemsOther"
                                        class={styles.checkboxGroup.label}
                                        autocapitalize="off">その他:</label
                                    >
                                    <input
                                        type="text"
                                        id="testItemsOtherText"
                                        name="testItemsOtherText"
                                        class={styles.checkboxGroup.otherInput}
                                        placeholder="具体的に記入"
                                    />
                                </div>
                            </div>
                        </div>
                    </section>
                    <section class="mb-4" aria-labelledby="scoring">
                        <h3
                            id="scoring"
                            class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200"
                        >
                            レビュー
                        </h3>

                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                授業の難易度<span class="text-red-500">*</span>
                            </label>
                            <div class={styles.form.slider.container}>
                                <div class={styles.form.slider.wrapper}>
                                    <input
                                        type="range"
                                        name="classDifficulty"
                                        min="-2"
                                        max="2"
                                        required
                                        value={formData?.classDifficulty ?? "0"}
                                        class={`${styles.form.slider.input}`}
                                    />
                                </div>
                                <div class={styles.form.slider.labels}>
                                    <span>難しい</span>
                                    <span>&cross;</span>
                                    <span>&emsp;簡単</span>
                                </div>
                            </div>
                            {
                                errors.classDifficulty && (
                                    <p class="text-red-500 text-sm">
                                        {errors.classDifficulty}
                                    </p>
                                )
                            }
                        </div>
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                テスト/レポートの難易度<span
                                    class="text-red-500">*</span
                                >
                            </label>
                            <div class={styles.form.slider.container}>
                                <div class={styles.form.slider.wrapper}>
                                    <input
                                        type="range"
                                        name="testDifficulty"
                                        min="-2"
                                        max="2"
                                        required
                                        value={formData?.testDifficulty ?? "0"}
                                        class={`${styles.form.slider.input} `}
                                    />
                                </div>
                                <div class={styles.form.slider.labels}>
                                    <span>難しい</span>
                                    <span>&cross;</span>
                                    <span>&emsp;簡単</span>
                                </div>
                            </div>
                            {
                                errors.testDifficulty && (
                                    <p class="text-red-500 text-sm">
                                        {errors.testDifficulty}
                                    </p>
                                )
                            }
                        </div>
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                テスト/レポートの量<span class="text-red-500"
                                    >*</span
                                >
                            </label>
                            <div class={styles.form.slider.container}>
                                <div class={styles.form.slider.wrapper}>
                                    <input
                                        type="range"
                                        name="testAmount"
                                        min="-2"
                                        max="2"
                                        required
                                        value={formData?.testAmount ?? "0"}
                                        class={`${styles.form.slider.input} `}
                                    />
                                </div>
                                <div class={styles.form.slider.labels}>
                                    <span>多い&emsp;</span>
                                    <span>&cross;</span>
                                    <span>少ない</span>
                                </div>
                            </div>
                            {
                                errors.testAmount && (
                                    <p class="text-red-500 text-sm">
                                        {errors.testAmount}
                                    </p>
                                )
                            }
                        </div>
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                成績の評定基準<span class="text-red-500">*</span
                                >
                            </label>
                            <div class={styles.form.slider.container}>
                                <div class={styles.form.slider.wrapper}>
                                    <input
                                        type="range"
                                        name="gradingCriteria"
                                        min="-2"
                                        max="2"
                                        required
                                        value={formData?.gradingCriteria ?? "0"}
                                        class={styles.form.slider.input}
                                    />
                                </div>
                                <div class={styles.form.slider.labels}>
                                    <span>厳しい</span>
                                    <span>&cross;</span>
                                    <span>&emsp;緩い</span>
                                </div>
                            </div>
                            {
                                errors.gradingCriteria && (
                                    <p class="text-red-500 text-sm">
                                        {errors.gradingCriteria}
                                    </p>
                                )
                            }
                        </div>
                        <div class={styles.form.group.container}>
                            <label class={styles.form.label}>
                                総合評価<span class="text-red-500">*</span>
                            </label>
                            <div class={styles.form.slider.container}>
                                <div class={styles.form.slider.wrapper}>
                                    <input
                                        type="range"
                                        name="totalscore"
                                        min="-2"
                                        max="2"
                                        required
                                        value={formData?.totalScore ?? "0"}
                                        class={styles.form.slider.input}
                                    />
                                </div>
                                <div class={styles.form.slider.labels}>
                                    <span>C</span>
                                    <span>B</span>
                                    <span>&emsp;</span>
                                    <span>A</span>
                                    <span>S</span>
                                </div>
                            </div>
                            {
                                errors.totalscore && (
                                    <p class="text-red-500 text-sm">
                                        {errors.totalscore}
                                    </p>
                                )
                            }
                        </div>
                    </section>
                    <section class="mb-4" aria-labelledby="comments">
                        <h3
                            id="scoring"
                            class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200"
                        >
                            感想
                        </h3>
                        <div class="mb-4">
                            <label for="goodPoint" class={styles.form.label}
                                >授業の良かったところ</label
                            >
                            <textarea
                                id="goodPoint"
                                name="goodPoint"
                                rows="3"
                                class={styles.form.textarea}></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="notGoodPoint" class={styles.form.label}
                                >授業の良くなかったところ</label
                            >
                            <textarea
                                id="notGoodPoint"
                                name="notGoodPoint"
                                rows="3"
                                class={styles.form.textarea}></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="comment" class={styles.form.label}
                                >その他</label
                            >
                            <textarea
                                id="comment"
                                name="comment"
                                rows="3"
                                class={styles.form.textarea}></textarea>
                        </div>
                    </section>
                </div>
                <div class="flex justify-center mt-6">
                    <button type="submit" class={styles.button.primary}>
                        投稿する
                    </button>
                </div>
            </form>
        </div>
    </section>
</Layout>

<script>
    // スライダーの値表示の処理は削除（初期値がないため）
    document.querySelectorAll('input[type="range"]').forEach((slider) => {
        if (!(slider instanceof HTMLInputElement)) return;

        // 初期値を未選択状態にする
        slider.value = "";

        // ユーザーが選択したときの処理
        slider.addEventListener("input", () => {
            // レンジが選択されたらそのまま
        });
    });

    // その他オプションの入力フィールド制御
    const handleOtherOption = (checkboxId: string, inputId: string) => {
        const checkbox = document.getElementById(
            checkboxId
        ) as HTMLInputElement;
        const input = document.getElementById(inputId) as HTMLInputElement;

        if (!checkbox || !input) return;

        // 初期状態の設定
        input.disabled = !checkbox.checked;
        if (!checkbox.checked) {
            input.value = "";
        }

        // チェックボックスの状態変更時の処理
        checkbox.addEventListener("change", () => {
            input.disabled = !checkbox.checked;
            if (!checkbox.checked) {
                input.value = "";
            }
        });
    };

    // テスト持ち込み「持ち込み無し」の処理
    const noItemsCheckbox = document.getElementById(
        "testItems1"
    ) as HTMLInputElement;
    const otherItemsCheckboxes = document.querySelectorAll(
        'input[name="testItems"]:not(#testItems1)'
    );

    if (noItemsCheckbox) {
        noItemsCheckbox.addEventListener("change", () => {
            otherItemsCheckboxes.forEach((checkbox) => {
                if (checkbox instanceof HTMLInputElement) {
                    checkbox.disabled = noItemsCheckbox.checked;
                    if (noItemsCheckbox.checked) {
                        checkbox.checked = false;
                        // その他のテキストフィールドもリセット
                        if (checkbox.id === "testItemsOther") {
                            const otherInput =
                                document.getElementById("testItemsOtherText");
                            if (otherInput instanceof HTMLInputElement) {
                                otherInput.value = "";
                                otherInput.disabled = true;
                            }
                        }
                    }
                }
            });
        });

        // 他のチェックボックスが選択された時の処理
        otherItemsCheckboxes.forEach((checkbox) => {
            if (checkbox instanceof HTMLInputElement) {
                checkbox.addEventListener("change", () => {
                    if (checkbox.checked) {
                        noItemsCheckbox.checked = false;
                    }
                });
            }
        });
    }

    // その他オプションの初期化
    handleOtherOption("courseTypeOther", "courseTypeOtherText");
    handleOtherOption("evalCriteriaOther", "evalCriteriaOtherText");
    handleOtherOption("testTypeOther", "testTypeOtherText");
    handleOtherOption("testItemsOther", "testItemsOtherText");
</script>
