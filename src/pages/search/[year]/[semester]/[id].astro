---
import Layout from "@/src/layouts/layout.astro";
import { styles } from "@/styles/style";
import { getReviews } from "@/utils/reviews";
import SimilarCourses from "@/components/similar-courses.astro";
import CourseInfo from "@/src/components/course-info.astro";
import { CourseSummarySchema } from "@/types/schema";
import Tabs from "@/src/components/tabs.astro";
import ReView from "@/src/components/re-view.astro";
import { z } from "astro/zod";
export const prerender = false;

const year = Astro.params.year;
const semester = Astro.params.semester;
const courseId = Astro.params.id;

if (!courseId || !year || !semester) {
    return new Response("Not Found", { status: 404 });
} else if (semester != "0" && semester != "1") {
    return Astro.redirect("/search", 302);
}

const reviews = await getReviews(courseId);
const url = new URL(`/api/courses/${year}/${semester}/data.json`, Astro.url);
let res;
try {
    res = await fetch(url);
} catch (e) {
    return new Response("Internal Server Error", { status: 500 });
}
const resonse = await res.json();
if (!resonse) {
    return new Response("Internal Server Error", { status: 500 });
}
const coursesResult = z.array(CourseSummarySchema).safeParse(resonse);
if (!coursesResult.success) {
    return new Response("Internal Server Error", { status: 500 });
}
const courses = coursesResult.data;
const course = courses.find((course) => year + course.id === courseId);

if (!course) {
    return new Response("Course Not Found", { status: 404 });
}
---

<Layout>
    <title slot="title">ハム大クロバス | 感想検索</title>
    <meta
        name="description"
        content="感想を共有して履修登録を助け合おう！"
        slot="description"
    />

    <CourseInfo id={courseId} />

    <Tabs>
        <Fragment slot="tab-1">感想</Fragment>
        <Fragment slot="tab-2">関連</Fragment>

        <section slot="panel-1">
            {
                !reviews || reviews.length === 0 ? (
                    <div class="flex flex-col items-center justify-center py-8 text-center">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="w-12 h-12 mb-3 text-gray-400 dark:text-gray-500"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="1.5"
                                d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            />
                        </svg>
                        <p class="text-lg font-medium text-gray-700 dark:text-gray-300">
                            まだ感想がありません。
                        </p>
                    </div>
                ) : (
                    <ReView reviews={reviews} year={year} semester={semester} />
                )
            }
        </section>

        <section slot="panel-2" class={styles.section.container}>
            <div class="mb-6">
                <h2 class=`${styles.section.title} my-4`>関連授業</h2>
                <p class={`text-gray-600 dark:text-gray-400 mb-4`}>
                    以下の授業は名前、担当教員、キャンパスなどの情報から同じ内容と思われる授業を掲載しています。
                </p>
            </div>
            <SimilarCourses
                year={year}
                courseId={courseId}
                name={course.name}
                teachers={course.teachers}
                campus={course.campus}
                period={course.period}
                semester={course.semester
                    ? course.semester
                    : year + "年度" + (semester == "0" ? "前期" : "後期")}
                server:defer
            >
                <span slot="fallback" class={styles.loading.fallbackText}>
                    Loading
                    <span class={styles.loading.spinner}></span>
                </span>
            </SimilarCourses>
        </section>
    </Tabs>
</Layout>
